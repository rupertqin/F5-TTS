# 需求文档

## 简介

本系统是一个基于F5-TTS的文本转语音文章生成器，能够将长篇文章智能切割成短句，使用多个音色生成高质量的语音文件，并自动生成对应的字幕文件。系统支持断点续传功能，可以在中断后继续生成，避免重复工作。

## 术语表

- **系统 (System)**: 指本文本转语音文章生成器
- **F5-TTS**: 底层的文本转语音模型引擎
- **音色文件 (Voice_File)**: WAV格式的参考音频文件，用于定义生成语音的音色特征
- **句子片段 (Sentence_Segment)**: 文章切割后的单个句子单元
- **音频片段 (Audio_Segment)**: 为单个句子片段生成的音频文件
- **字幕文件 (Subtitle_File)**: SRT格式的字幕文件
- **缓存管理器 (Cache_Manager)**: 负责管理已生成文件的缓存机制
- **文章切割器 (Article_Splitter)**: 负责将文章切割成句子片段的组件
- **音频生成器 (Audio_Generator)**: 负责调用F5-TTS生成音频的组件
- **字幕生成器 (Subtitle_Generator)**: 负责生成SRT字幕的组件
- **文件拼接器 (File_Concatenator)**: 负责拼接多个音频和字幕文件的组件

## 需求

### 需求 1: 文章切割

**用户故事:** 作为用户，我希望系统能够智能地将长篇文章切割成适合语音合成的短句，以便生成自然流畅的语音。

#### 验收标准

1. WHEN 用户提供一篇文章文本，THE 文章切割器 SHALL 将文章按照标点符号和语义边界切割成句子片段
2. THE 文章切割器 SHALL 确保每个句子片段的长度不超过200个字符
3. WHEN 句子片段超过200个字符，THE 文章切割器 SHALL 在逗号、分号或其他合适的标点处进一步切割
4. THE 文章切割器 SHALL 保留原文的标点符号和换行信息
5. THE 文章切割器 SHALL 为每个句子片段分配唯一的序号

### 需求 2: 多音色管理

**用户故事:** 作为用户，我希望能够使用多个不同的音色文件来生成语音，以便为不同的角色或段落使用不同的声音。

#### 验收标准

1. THE 系统 SHALL 接受用户提供的多个WAV格式音色文件
2. WHEN 用户提供音色文件，THE 系统 SHALL 验证文件格式为有效的WAV音频文件
3. THE 系统 SHALL 为每个音色文件分配一个唯一的标识符
4. THE 系统 SHALL 允许用户为每个音色文件指定一个友好的名称
5. WHEN 用户在文章中使用音色标记（如[voice_name]），THE 系统 SHALL 识别并应用对应的音色文件

### 需求 3: 音频生成

**用户故事:** 作为用户，我希望系统能够使用F5-TTS的Multi-speech功能为每个句子片段生成高质量的音频文件。

#### 验收标准

1. THE 音频生成器 SHALL 使用F5-TTS模型为每个句子片段生成音频
2. WHEN 生成音频时，THE 音频生成器 SHALL 使用用户指定的音色文件作为参考音频
3. THE 音频生成器 SHALL 为每个句子片段生成独立的WAV格式音频文件
4. THE 音频生成器 SHALL 将生成的音频文件保存到指定的输出目录
5. WHEN 音频生成失败，THE 音频生成器 SHALL 记录错误信息并继续处理下一个句子片段
6. THE 音频生成器 SHALL 支持配置生成参数（如采样率、语速、音量等）

### 需求 4: 字幕生成

**用户故事:** 作为用户，我希望系统能够自动生成与音频同步的SRT格式字幕文件，以便在播放时显示文本内容。

#### 验收标准

1. THE 字幕生成器 SHALL 为每个音频片段生成对应的字幕条目
2. THE 字幕生成器 SHALL 计算每个音频片段的时长
3. THE 字幕生成器 SHALL 根据音频片段的时长和顺序生成准确的时间戳
4. THE 字幕生成器 SHALL 使用标准SRT格式输出字幕文件
5. THE 字幕生成器 SHALL 确保字幕文本与原始句子片段内容一致
6. THE 字幕生成器 SHALL 为每个字幕条目分配连续的序号

### 需求 5: 文件拼接

**用户故事:** 作为用户，我希望系统能够将所有生成的音频片段和字幕片段拼接成完整的音频文件和字幕文件。

#### 验收标准

1. THE 文件拼接器 SHALL 按照句子片段的顺序拼接所有音频片段
2. THE 文件拼接器 SHALL 在拼接音频时保持音频质量不变
3. THE 文件拼接器 SHALL 按照句子片段的顺序合并所有字幕条目
4. THE 文件拼接器 SHALL 在合并字幕时重新计算时间戳以确保连续性
5. THE 文件拼接器 SHALL 将最终的音频文件保存为WAV格式
6. THE 文件拼接器 SHALL 将最终的字幕文件保存为SRT格式
7. WHEN 拼接完成，THE 文件拼接器 SHALL 输出最终文件的路径信息

### 需求 6: 断点续传

**用户故事:** 作为用户，我希望系统能够记住已经生成的文件，在中断后继续生成，避免重复工作和浪费时间。

#### 验收标准

1. THE 缓存管理器 SHALL 为每个生成任务创建唯一的缓存标识
2. WHEN 生成音频片段后，THE 缓存管理器 SHALL 记录该片段已完成的状态
3. WHEN 系统重新启动或继续任务时，THE 缓存管理器 SHALL 检查哪些片段已经生成
4. THE 系统 SHALL 跳过已经生成的音频片段，只生成缺失的片段
5. THE 缓存管理器 SHALL 将缓存信息保存到持久化存储（如JSON文件）
6. WHEN 用户明确要求重新生成，THE 系统 SHALL 清除缓存并重新生成所有片段
7. THE 缓存管理器 SHALL 验证已缓存文件的完整性（如文件是否存在、大小是否合理）

### 需求 7: 配置管理

**用户故事:** 作为用户，我希望能够通过配置文件灵活地控制系统的行为和参数。

#### 验收标准

1. THE 系统 SHALL 支持通过配置文件（如TOML或JSON格式）指定输入文章路径
2. THE 系统 SHALL 支持通过配置文件指定音色文件路径和名称映射
3. THE 系统 SHALL 支持通过配置文件指定输出目录路径
4. THE 系统 SHALL 支持通过配置文件配置F5-TTS模型参数（如模型名称、采样步数等）
5. THE 系统 SHALL 支持通过配置文件配置文章切割参数（如最大句子长度）
6. WHEN 配置文件不存在或格式错误，THE 系统 SHALL 使用默认配置并输出警告信息

### 需求 8: 错误处理

**用户故事:** 作为用户，我希望系统能够优雅地处理各种错误情况，并提供清晰的错误信息。

#### 验收标准

1. WHEN 输入文章文件不存在，THE 系统 SHALL 输出错误信息并终止执行
2. WHEN 音色文件不存在或格式无效，THE 系统 SHALL 输出错误信息并终止执行
3. WHEN F5-TTS模型加载失败，THE 系统 SHALL 输出详细的错误信息并终止执行
4. WHEN 单个音频片段生成失败，THE 系统 SHALL 记录错误但继续处理其他片段
5. WHEN 输出目录不存在，THE 系统 SHALL 自动创建该目录
6. WHEN 磁盘空间不足，THE 系统 SHALL 输出错误信息并终止执行
7. THE 系统 SHALL 将所有错误和警告信息记录到日志文件

### 需求 9: 进度显示

**用户故事:** 作为用户，我希望能够实时看到生成进度，了解任务的完成情况。

#### 验收标准

1. THE 系统 SHALL 在开始处理时显示总句子片段数量
2. WHEN 处理每个句子片段时，THE 系统 SHALL 显示当前进度（如"处理中: 5/100"）
3. THE 系统 SHALL 显示每个句子片段的生成状态（成功、失败、跳过）
4. WHEN 使用缓存时，THE 系统 SHALL 显示跳过的片段数量
5. THE 系统 SHALL 在完成时显示总耗时和成功/失败的统计信息
6. THE 系统 SHALL 使用进度条或百分比显示整体进度

### 需求 10: 命令行接口

**用户故事:** 作为用户，我希望能够通过命令行方便地运行系统并指定参数。

#### 验收标准

1. THE 系统 SHALL 提供命令行接口用于启动生成任务
2. THE 系统 SHALL 支持通过命令行参数指定配置文件路径
3. THE 系统 SHALL 支持通过命令行参数指定输入文章路径
4. THE 系统 SHALL 支持通过命令行参数指定输出目录
5. THE 系统 SHALL 支持通过命令行参数启用或禁用缓存功能
6. THE 系统 SHALL 提供帮助信息（--help）显示所有可用的命令行参数
7. WHEN 命令行参数与配置文件冲突，THE 系统 SHALL 优先使用命令行参数
