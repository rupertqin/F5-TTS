# 实现计划: TTS文章生成器

## 概述

本实现计划将基于F5-TTS的文本转语音文章生成器分解为一系列增量开发任务。每个任务都建立在前面的任务之上，确保代码逐步集成，没有孤立的未使用代码。

## 当前状态

- F5-TTS API已可用 (src/f5_tts/api.py)
- 所有依赖已安装 (pydub, soundfile, torchaudio等)
- 需要创建新的tts_article_generator模块

## 任务

- [x] 1. 搭建项目结构和配置管理
  - [x] 1.1 创建项目目录结构
    - 创建tts_article_generator/目录及子模块
    - 创建**init**.py和**main**.py
    - 创建examples/目录用于示例文件
    - _需求: 7.1_

  - [x] 1.2 实现配置数据类
    - 实现Config数据类（使用dataclass）
    - 实现VoiceConfig数据类
    - 定义所有配置字段和默认值
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 1.3 实现ConfigManager类
    - 实现load_config方法（TOML文件加载）
    - 实现get_default_config方法
    - 实现validate_config方法（路径验证、参数检查）
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

  - [x] 1.4 创建示例配置文件
    - 创建examples/config.toml
    - 包含所有配置项的示例
    - 添加注释说明
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 1.5 编写配置管理的单元测试
    - 测试TOML文件加载
    - 测试配置验证
    - 测试默认配置
    - 测试无效配置处理
    - _需求: 7.6_

- [ ] 2. 实现文章切割器
  - [x] 2.1 实现SentenceSegment数据类
    - 定义片段的数据结构（序号、文本、音色名称）
    - 使用dataclass装饰器
    - _需求: 1.5_

  - [x] 2.2 实现ArticleSplitter类的基本切割功能
    - 实现**init**方法（接受max_length参数）
    - 实现\_split_by_punctuation方法（按标点符号切割）
    - 实现长度限制检查和二次切割逻辑
    - 为每个片段分配连续序号
    - _需求: 1.1, 1.2, 1.3, 1.5_

  - [x] 2.3 实现音色标记解析功能
    - 实现\_parse_voice_markers方法
    - 使用正则表达式识别[voice_name]标记
    - 将文本与音色名称关联
    - _需求: 2.5_

  - [x] 2.4 实现split主方法
    - 整合标点切割和音色解析
    - 返回SentenceSegment列表
    - 处理边缘情况（空文本、无标点等）
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.5_

  - [~] 2.5 编写文章切割器的属性测试
    - **属性 1: 句子片段长度限制**
    - **属性 2: 切割点位于标点符号**
    - **属性 3: 切割保留原文内容**
    - **属性 4: 片段序号唯一且连续**
    - **属性 7: 音色标记识别**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 1.1, 1.2, 1.3, 1.4, 1.5, 2.5_

  - [~] 2.6 编写文章切割器的单元测试
    - 测试空文章
    - 测试单句文章
    - 测试包含音色标记的文章
    - 测试边缘情况（超长句子、连续标点、特殊字符）
    - 测试中英文混合文本
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.5_

- [ ] 3. 实现缓存管理器
  - [~] 3.1 实现CacheEntry数据类
    - 定义缓存条目的数据结构
    - 包含所有必要字段（segment_index, audio_path, duration等）
    - _需求: 6.2_

  - [~] 3.2 实现CacheManager类的初始化和任务ID生成
    - 实现**init**方法
    - 实现generate_task_id方法（基于文章和配置的哈希）
    - _需求: 6.1_

  - [~] 3.3 实现缓存加载和保存功能
    - 实现load_cache方法（从JSON加载）
    - 实现save_cache方法（保存到JSON）
    - 实现get_entry和add_entry方法
    - _需求: 6.2, 6.3, 6.5_

  - [~] 3.4 实现缓存验证和清除功能
    - 实现validate_entry方法（文件存在、大小检查）
    - 实现clear_cache方法
    - _需求: 6.6, 6.7_

  - [~] 3.5 编写缓存管理器的属性测试
    - **属性 16: 缓存任务ID唯一性**
    - **属性 17: 缓存往返一致性**
    - **属性 19: 缓存完整性验证**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 6.1, 6.2, 6.3, 6.5, 6.7_

  - [~] 3.6 编写缓存管理器的单元测试
    - 测试缓存创建
    - 测试缓存加载
    - 测试缓存清除
    - 测试边缘情况（损坏的缓存文件、缺失的音频文件）
    - _需求: 6.1, 6.2, 6.3, 6.5, 6.6, 6.7_

- [~] 4. 检查点 - 验证核心数据结构
  - 运行所有现有测试确保通过
  - 验证配置、切割器、缓存管理器可以正常工作
  - 手动测试配置加载和文章切割功能
  - 如有问题请向用户询问

- [ ] 5. 实现音频生成器
  - [x] 5.1 实现AudioGenerator类的初始化
    - 实现**init**方法（接受Config参数）
    - 集成F5-TTS API（f5_tts.api.F5TTS）
    - 实现懒加载模型初始化（initialize_model方法）
    - 支持配置模型参数（nfe_step、cfg_strength、speed等）
    - _需求: 3.1, 3.6_

  - [x] 5.2 实现音频生成功能
    - 实现generate方法
    - 调用F5-TTS的infer方法生成音频
    - 使用指定的音色文件作为参考音频
    - 将生成的音频保存为WAV文件
    - _需求: 3.1, 3.2, 3.3, 3.4_

  - [~] 5.3 实现音频时长获取
    - 实现get_audio_duration方法
    - 使用soundfile或torchaudio读取音频时长
    - _需求: 3.4_

  - [~] 5.4 实现错误处理
    - 捕获生成失败的异常
    - 记录错误日志但不中断流程
    - 返回错误状态供调用者处理
    - _需求: 3.5, 8.4_

  - [~] 5.5 编写音频生成器的属性测试（使用Mock）
    - **属性 8: 音频文件生成完整性**
    - **属性 9: 音频生成错误隔离**
    - 使用unittest.mock模拟F5-TTS API
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 3.1, 3.2, 3.3, 3.4, 3.5_

  - [~] 5.6 编写音频生成器的单元测试
    - 测试模型初始化
    - 测试参数配置
    - 测试文件保存
    - 测试边缘情况（空文本、超长文本、特殊字符）
    - 使用Mock避免实际模型加载
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 6. 实现字幕生成器
  - [~] 6.1 实现SubtitleEntry数据类
    - 定义字幕条目的数据结构（序号、开始时间、结束时间、文本）
    - 使用dataclass装饰器
    - _需求: 4.1_

  - [~] 6.2 实现SubtitleGenerator类的基本功能
    - 实现**init**方法
    - 实现create_entry方法（创建字幕条目）
    - 实现format_time方法（秒转SRT格式 HH:MM:SS,mmm）
    - _需求: 4.1, 4.2, 4.3_

  - [~] 6.3 实现SRT文件生成
    - 实现generate_srt方法
    - 按标准SRT格式输出
    - 移除音色标记
    - 确保文本与原始片段一致
    - 分配连续的序号
    - _需求: 4.4, 4.5, 4.6_

  - [~] 6.4 编写字幕生成器的属性测试
    - **属性 10: 字幕条目完整性**
    - **属性 11: SRT格式往返一致性**
    - **属性 12: 字幕文本一致性**
    - **属性 13: 字幕序号连续性**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

  - [~] 6.5 编写字幕生成器的单元测试
    - 测试时间格式化
    - 测试SRT文件生成
    - 测试边缘情况（零时长音频、超长文本）
    - 测试音色标记移除
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 7. 实现文件拼接器
  - [~] 7.1 实现FileConcatenator类的初始化
    - 实现**init**方法
    - _需求: 5.1_

  - [~] 7.2 实现音频拼接功能
    - 实现concatenate_audio方法
    - 使用pydub的AudioSegment拼接音频
    - 支持交叉淡入淡出（cross-fade）
    - 保持音频质量和格式一致
    - _需求: 5.1, 5.2, 5.5_

  - [~] 7.3 实现字幕合并功能
    - 实现concatenate_subtitles方法
    - 按顺序合并字幕条目
    - 重新计算时间戳确保连续性
    - 生成最终的SRT文件
    - _需求: 5.3, 5.4, 5.6, 5.7_

  - [~] 7.4 编写文件拼接器的属性测试
    - **属性 14: 拼接顺序保持**
    - **属性 15: 字幕时间戳连续性**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 5.1, 5.3, 5.4_

  - [~] 7.5 编写文件拼接器的单元测试
    - 测试音频拼接
    - 测试字幕合并
    - 测试边缘情况（单个片段、空片段列表）
    - 测试交叉淡入淡出效果
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

- [~] 8. 检查点 - 验证所有组件
  - 运行所有组件的测试确保通过
  - 验证组件之间的接口兼容性
  - 手动测试各组件的基本功能
  - 如有问题请向用户询问

- [ ] 9. 实现生成流水线
  - [~] 9.1 实现GenerationPipeline类的初始化
    - 实现**init**方法（接受Config参数）
    - 初始化所有组件（配置、切割器、缓存、生成器等）
    - 设置日志系统
    - _需求: 8.7_

  - [~] 9.2 实现文章加载功能
    - 实现\_load_article方法
    - 从文件读取文章文本
    - 处理文件不存在的错误
    - _需求: 8.1_

  - [~] 9.3 实现片段处理流程
    - 实现\_process_segments方法
    - 切割文章为片段
    - 对每个片段：检查缓存、生成音频、生成字幕、更新缓存
    - 使用tqdm显示进度
    - 统计成功/失败/跳过的片段
    - _需求: 6.3, 6.4, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

  - [~] 9.4 实现最终拼接和输出
    - 在run方法中整合所有步骤
    - 拼接所有音频和字幕
    - 保存最终文件
    - 输出结果路径和统计信息
    - _需求: 5.7, 9.5_

  - [~] 9.5 实现错误处理和日志记录
    - 处理各种错误情况（文件不存在、模型加载失败等）
    - 记录所有错误和警告到日志文件
    - 实现优雅的错误恢复
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

  - [~] 9.6 编写流水线的属性测试
    - **属性 18: 缓存跳过逻辑**
    - **属性 20: 错误日志记录**
    - 使用hypothesis库，每个属性至少100次迭代
    - 使用Mock模拟F5-TTS API
    - _验证: 需求 6.4, 8.7_

  - [~] 9.7 编写流水线的单元测试
    - 测试文章加载
    - 测试片段处理流程
    - 测试错误处理
    - 测试进度显示
    - 使用Mock避免实际模型加载
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [ ] 10. 实现命令行接口
  - [~] 10.1 实现参数解析
    - 实现parse_arguments函数
    - 使用argparse定义所有命令行参数
    - 实现帮助信息
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

  - [~] 10.2 实现参数优先级逻辑
    - 加载配置文件
    - 用命令行参数覆盖配置文件
    - 实现配置合并逻辑
    - _需求: 10.7_

  - [~] 10.3 实现日志系统配置
    - 实现setup_logging函数
    - 配置日志格式和输出
    - 支持不同日志级别
    - _需求: 8.7_

  - [~] 10.4 实现主入口函数
    - 实现main函数
    - 初始化日志系统
    - 创建并运行GenerationPipeline
    - 处理顶层异常
    - 输出最终结果
    - _需求: 10.1_

  - [ ] 10.5 实现**main**.py
    - 创建模块入口点
    - 调用main函数
    - _需求: 10.1_

  - [~] 10.6 编写命令行接口的属性测试
    - **属性 21: 命令行参数优先级**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 10.7_

  - [~] 10.7 编写命令行接口的单元测试
    - 测试参数解析
    - 测试帮助信息
    - 测试边缘情况（无效参数、参数冲突）
    - 测试配置合并逻辑
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [ ] 11. 实现音色文件验证
  - [~] 11.1 实现WAV格式验证功能
    - 在ConfigManager中添加validate_voice_files方法
    - 检查文件是否为有效的WAV音频
    - 在配置加载时验证所有音色文件
    - _需求: 2.1, 2.2, 8.2_

  - [~] 11.2 编写音色验证的属性测试
    - **属性 5: 音色文件格式验证**
    - **属性 6: 音色标识符唯一性**
    - 使用hypothesis库，每个属性至少100次迭代
    - _验证: 需求 2.2, 2.3_

  - [~] 11.3 编写音色验证的单元测试
    - 测试有效WAV文件
    - 测试无效文件格式
    - 测试音色标识符唯一性
    - _需求: 2.1, 2.2, 2.3_

- [ ] 12. 创建示例和文档
  - [x] 12.1 创建示例文章文件
    - 创建examples/article.txt
    - 包含中英文混合内容
    - 包含音色标记示例
    - _需求: 所有需求_

  - [~] 12.2 准备示例音色文件
    - 创建examples/voices/目录
    - 添加示例WAV文件（如果可能）
    - 或提供获取音色文件的说明
    - _需求: 2.1, 2.2_

  - [~] 12.3 创建README.md
    - 说明项目功能和特性
    - 提供安装说明
    - 提供使用示例
    - 说明配置文件格式
    - 说明命令行参数
    - 提供故障排除指南
    - _需求: 所有需求_

- [ ] 13. 最终检查点 - 集成测试
  - [~] 13.1 编写端到端集成测试
    - 使用小型测试文章完整运行流水线
    - 验证最终输出文件的存在和格式
    - 测试断点续传功能（中断后继续）
    - 使用Mock模拟F5-TTS API以加快测试
    - _需求: 所有需求_

  - [~] 13.2 运行所有测试
    - 运行所有单元测试
    - 运行所有属性测试
    - 运行集成测试
    - 确保所有测试通过
    - 检查测试覆盖率

  - [~] 13.3 手动测试（可选）
    - 使用示例文章运行完整流程
    - 验证生成的音频和字幕质量
    - 测试各种命令行参数组合
    - 测试错误处理和边缘情况
    - 如有问题请向用户询问

## 注意事项

- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证
- 属性测试使用Python的hypothesis库，每个测试至少运行100次迭代
- 单元测试验证特定示例和边缘情况
- 属性测试和单元测试是互补的，共同确保全面覆盖
- 音频生成器测试使用Mock避免实际加载F5-TTS模型
- 任务13.3（手动测试）是可选的，因为需要实际的F5-TTS模型和音色文件

## 测试框架

- **单元测试**: pytest
- **属性测试**: hypothesis
- **Mock**: unittest.mock
- **测试覆盖率**: pytest-cov

## 项目结构

```
tts_article_generator/
├── __init__.py
├── __main__.py              # CLI入口
├── config.py                # 配置管理
├── splitter.py              # 文章切割
├── cache.py                 # 缓存管理
├── audio_generator.py       # 音频生成
├── subtitle_generator.py    # 字幕生成
├── concatenator.py          # 文件拼接
├── pipeline.py              # 生成流水线
└── utils.py                 # 工具函数

tests/
├── __init__.py
├── test_config.py
├── test_splitter.py
├── test_cache.py
├── test_audio_generator.py
├── test_subtitle_generator.py
├── test_concatenator.py
├── test_pipeline.py
├── test_cli.py
└── test_integration.py

examples/
├── config.toml              # 示例配置
├── article.txt              # 示例文章
└── voices/                  # 示例音色文件
    ├── main.wav
    └── narrator.wav
```
